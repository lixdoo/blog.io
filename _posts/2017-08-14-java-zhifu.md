---
layout: post
title: 支付模块
date: 2017-8-14
categories: blog
tags: [支付,编程式事务，乐观锁]
description: 分布式支付一致性问题
---


### 数据库事务
1. 数据库是指作为单个逻辑工作单元执行的一系列操作，要么完全执行，要么完全不执行。一个逻辑单元要成为事务，必须满足ACID,即原子性、一致性、隔离性和持久性。  
>原子性：事务必须是原子工作单位，对于数据修改，要么全部执行，要么全部不执行。  
一致性：事务完成时，必须使得所有数据都保持一致状态。  
隔离性：由并非事务所作的修改必须与其他并非是我所作的修改隔离。事务查看数据所处的状态，要么是另一个事务修改它之前的状态，要么是修改它之后的状态。  
持久性：事务完成后，对系统的影响是永久的。  

2. 事务的隔离级别
若不考虑数据库事务的隔离性，多个线程访问数据库时就会出现以下几种情形：  
脏读：一个事务处理过程中读取了另一个未提交的事务中的数据；  
不可重复读：对于某个数据来说，在一个事务内多次查询数据得到不同的数据值；  
虚读：也称作幻读，例如订单处理中，T1事务批量修改了订单状态（未处理->已处理），T2插入一条新订单(未处理)，此时操作T1修改订单状态的人会发现有订单状态尚未修改；  

MySQL数据库提供的四种隔离级别：  
>serializable:可避免脏读、不可重复读以及幻读；  
repeatable read（可重复读)：可避免脏读和不可重复读；  
read committed：可避免脏读；  
read uncommitted：最低级别，任何情况都无法避免；  
mysql 默认级别是：repeatable read，即默认避免脏读和不可重复读；  

###  Spring事务机制
Spring有两种事务管理机制，一是声明式事务，二是编程式事务。  
1. 声明式事务  
声明式事务实现是AOP的一种应用实现，声明式事务的好处是无需在业务逻辑代码中掺杂事务管理的代码。和编程式事务相比，声明式事务的缺点是管理粒度最小为方法，无法做到像编程式事务那样达到代码块级别。  
#### 配置方式  
Spring事务配置有5种方式，Spring事务管理配置主要由三个组成部分组成，分别是DataSource、TransactionManger和代理机制这三个部分。对于不同的配置方式来说，变化的部分是代理机制这部分。详细参考如下图：  

<center>
    <p><img src="http://otzyx82p7.bkt.clouddn.com/Spring%E4%BA%8B%E5%8A%A1%E9%85%8D%E7%BD%AE%20%282%29.jpg" align="center"></p>
</center>
